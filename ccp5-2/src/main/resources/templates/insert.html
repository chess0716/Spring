<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insert New Board</title>
    <link rel="stylesheet" href="/assets/css/main.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            margin: 10%;
        }
    </style>
</head>
<body>
    <header id="header" th:replace="include/header :: header"></header>

    <!-- Menu -->
    <nav id="menu">
        <h2>Menu</h2>
        <ul>
            <li><a th:href="@{/}">Home</a></li>
            <li><a th:href="@{/view}">Ipsum veroeros</a></li>
            <li><a th:href="@{/view}">Tempus etiam</a></li>
            <li><a th:href="@{/view.html}">Consequat dolor</a></li>
            <li><a th:href="@{/elements.html}">Elements</a></li>
        </ul>
    </nav>

    <h2>Insert New Board</h2>
    <div class="content mt-3">
        <form id="boardForm" enctype="multipart/form-data" class="recipe-form">
            <div class="mb-3 mt-3">
                <label for="title">TITLE</label>
                <input type="text" class="form-control" id="title" placeholder="Enter title" name="title" />
            </div>
            <div class="mb-3 mt-3">
                <label for="content">CONTENT</label>
                <textarea class="form-control" rows="10" id="content" name="content"></textarea>
            </div>
            <div class="mb-3 mt-3">
                <label for="file">Image:</label>
                <input type="file" id="file" name="file">
            </div>
        </form>
    </div>

    <div id="basicFormSection">
        <form class="ingredient-form">
            <select name="categoryId">
                <option value="">카테고리 선택</option>
                <option th:each="category : ${categories}" th:value="${category}" th:text="${category}"></option>
            </select>
            <select class="mb-3 col" name="name">
                <option value="">이름 선택</option>
            </select>
            <label for="unit">수량(개/g)</label>
            <textarea id="unit" name="unit"></textarea>
            <button class="btn btn-primary addForm">+</button>
        </form>
    </div>

    <div id="newFormsSection"></div>
    <button type="button" id="submit-all">Submit All Forms</button>

    <script>
        $(document).ready(function() {
            // "+(플러스)" 버튼 클릭 이벤트 처리
            $(document).on('click', '.addForm', function(e) {
                e.preventDefault(); // 기본 동작 방지

                // 폼 복제
                var newForm = $('.ingredient-form').first().clone();

                // 입력 필드 초기화
                newForm.find('textarea').val('');
                newForm.find('select').prop('selectedIndex', 0);

                // "-(마이너스)" 버튼 추가
                newForm.append('<button class="btn btn-secondary removeForm">-</button>');

                // 새로운 폼을 새로운 섹션에 추가
                $('#newFormsSection').append(newForm);

                return false;
            });

            // "-(마이너스)" 버튼 클릭 이벤트 처리
            $(document).on('click', '.removeForm', function(e) {
                e.preventDefault(); // 기본 동작 방지

                // 해당 폼 제거
                $(this).closest('.ingredient-form').remove();

                return false;
            });

            // 선택된 카테고리에 따라 이름을 업데이트하는 함수
            function updateNames(form) {
                var categorySelect = form.find('select[name="categoryId"]');
                var nameSelect = form.find('select[name="name"]');

                categorySelect.on('change', function() {
                    var categoryId = $(this).val();
                    if (categoryId !== "") {
                        $.ajax({
                            url: "/get_names", // 카테고리에 따른 이름 목록을 가져올 엔드포인트
                            method: "GET",
                            data: {
                                categoryId: categoryId
                            },
                            contentType: "application/json;charset=utf-8",
                            dataType: "json",
                            success: function(response) {
                                nameSelect.empty(); // 셀렉트 박스 비우기
                                nameSelect.append('<option value="">이름 선택</option>'); // 기본 옵션 추가
                                response.forEach(function(name) {
                                    nameSelect.append('<option value="' + name.name + '">' + name.name + '</option>'); // 이름 옵션 추가
                                });
                            },
                            error: function(xhr, status, error) {
                                console.error(xhr.responseText); // 에러 처리
                            }
                        });
                    } else {
                        nameSelect.empty(); // 카테고리가 선택되지 않은 경우 이름 셀렉트 박스 비우기
                        nameSelect.append('<option value="">이름 선택</option>'); // 기본 옵션 추가
                    }
                });
            }

            // 페이지 로드 시 초기화
            $('.ingredient-form').each(function() {
                updateNames($(this));
            });

            // 폼 제출 버튼 클릭 시 모든 폼 데이터를 서버로 전송
            $('#submit-all').click(function() {
                var boardFormData = new FormData();
                var ingredientData = [];

                $('.ingredient-form').each(function() {
                    var categoryId = $(this).find('select[name="categoryId"]').val();
                    var name = $(this).find('select[name="name"]').val();
                    var unit = $(this).find('textarea[name="unit"]').val();

                    if (categoryId && name && unit) {
                        ingredientData.push({ categoryId: categoryId, name: name, unit: unit });
                    }
                });

                boardFormData.append('file', $('#file')[0].files[0]);
                boardFormData.append('formData', JSON.stringify({forms: ingredientData, title: $('#title').val(), content: $('#content').val()}));

                $.ajax({
                    url: '/submit_all_forms',
                    type: 'POST',
                    data: boardFormData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        alert('성공적으로 제출되었습니다!');
                        // 선택적으로 리디렉션 또는 UI 업데이트를 여기서 수행할 수 있습니다.
                    },
                    error: function(xhr, status, error) {
                        alert('오류가 발생했습니다.');
                        console.log(xhr, status, error);
                    }
                });
            });
        });
    </script>
</body>
</html>
